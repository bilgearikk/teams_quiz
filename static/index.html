<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>ToplantÄ± Quiz Oyunu</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #6e8efb, #a777e3);
    color: white;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
  }
  header {
    margin: 20px; font-size: 2em; font-weight: bold;
    text-shadow: 0 0 8px #fff;
  }
  #login {
    margin: 20px;
  }
  #login input {
    font-size: 1.2em;
    padding: 10px;
    border-radius: 8px;
    border: none;
    width: 250px;
  }
  #login button {
    padding: 10px 20px;
    font-size: 1.2em;
    border-radius: 8px;
    border: none;
    background-color: #ff6b6b;
    color: white;
    cursor: pointer;
    margin-left: 10px;
    transition: background-color 0.3s ease;
  }
  #login button:hover {
    background-color: #ff8787;
  }

  #controls {
    display:none;
    margin: 10px 0 0;
  }
  #controls button {
    padding: 8px 14px;
    font-size: 1em;
    border-radius: 10px;
    border: none;
    background: #00c897;
    color: #0b1726;
    cursor: pointer;
  }

  #game {
    display: none;
    max-width: 600px;
    width: 100%;
    background: rgba(0,0,0,0.25);
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
  }
  #question {
    font-size: 1.8em;
    margin-bottom: 20px;
    text-align: center;
    text-shadow: 0 0 6px #000;
  }
  #answers {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
  }
  .answer-btn {
    flex: 1 1 45%;
    background: #4a69bd;
    border: none;
    padding: 20px;
    font-size: 1.3em;
    border-radius: 15px;
    color: white;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: background-color 0.25s ease;
  }
  .answer-btn:hover:not(:disabled) {
    background: #6a89cc;
  }
  .answer-btn:disabled {
    background: #7f8fa6;
    cursor: not-allowed;
  }
  #answerer-info {
    margin: 15px 0;
    font-size: 1.1em;
    text-align: center;
    opacity: 0.9;
  }
  #timer {
    font-size: 2em;
    text-align: center;
    margin: 10px 0 30px;
    font-weight: bold;
  }
  #scores {
    margin-top: 30px;
    background: rgba(255, 255, 255, 0.15);
    padding: 15px;
    border-radius: 12px;
  }
  #scores h3 {
    margin-top: 0;
  }
  #scores ul {
    list-style: none;
    padding-left: 0;
    font-size: 1.1em;
  }
  #scores li {
    padding: 5px 0;
    border-bottom: 1px solid rgba(255,255,255,0.3);
  }
  #log {
    max-width: 600px;
    width: 100%;
    margin-top: 30px;
    min-height: 100px;
    max-height: 200px;
    overflow-y: auto;
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 15px;
    font-size: 1em;
    color: #f1f1f1;
  }
  #winner-box {
    display:none;
    margin-top: 20px;
    padding: 14px 18px;
    border-radius: 12px;
    background: rgba(255, 215, 0, 0.9);
    color: #1a1a1a;
    font-weight: 700;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }
</style>
</head>
<body>

<header>Meeting Quiz Oyunu ðŸŽ‰</header>

<div id="login">
  <input id="username" type="text" placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin (mod = moderatÃ¶r)" />
  <button id="connectBtn">KatÄ±l</button>
</div>

<div id="controls">
  <button id="startBtn">Yeni Soru BaÅŸlat</button>
</div>

<div id="game">
  <div id="answerer-info">Herkes aynÄ± anda cevap verebilir.</div>
  <div id="question">Soru burada gÃ¶rÃ¼necek...</div>
  <div id="answers"></div>
  <div id="timer">10</div>

  <div id="scores">
    <h3>Puanlar</h3>
    <ul id="scoresList"></ul>
  </div>
</div>

<div id="winner-box"></div>
<div id="log"></div>

<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
  // ==== ELEMENTLER ====
  const connectBtn = document.getElementById("connectBtn");
  const usernameInput = document.getElementById("username");
  const controlsDiv = document.getElementById("controls");
  const startBtn = document.getElementById("startBtn");
  const gameDiv = document.getElementById("game");
  const questionDiv = document.getElementById("question");
  const answersDiv = document.getElementById("answers");
  const timerDiv = document.getElementById("timer");
  const scoresList = document.getElementById("scoresList");
  const logDiv = document.getElementById("log");
  const winnerBox = document.getElementById("winner-box");

  // ==== DURUMLAR ====
  let socket = null;
  let participantId = null;
  let currentRoundId = null;
  let joinSent = false;
  let timerInterval = null;

  function log(msg) {
    const p = document.createElement("p");
    p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
    console.log(msg);
  }

  function disableChoices() {
    document.querySelectorAll(".answer-btn").forEach(b => b.disabled = true);
  }

  function startTimer(seconds) {
    let remaining = seconds;
    timerDiv.textContent = remaining;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      remaining--;
      timerDiv.textContent = remaining;
      if (remaining <= 0) {
        clearInterval(timerInterval);
        disableChoices();
      }
    }, 1000);
  }

  // ==== KATIL ====
  connectBtn.onclick = () => {
    const name = usernameInput.value.trim();
    if (!name) {
      alert("LÃ¼tfen kullanÄ±cÄ± adÄ±nÄ±zÄ± girin.");
      return;
    }
    if (joinSent) return;

    // Socket.IO'ya baÄŸlan
    socket = io({
      path: "/socket.io/",
      // Render arkasÄ±nda genelde upgrade baÅŸarÄ±lÄ±; sorun olursa sadece websocket'e dÃ¼ÅŸÃ¼rebilirsin:
      // transports: ["websocket"],
      withCredentials: false,
    });

    // BaÄŸlantÄ± olaylarÄ± (gÃ¶rÃ¼nÃ¼r log)
    socket.on("connect", () => {
      log("Socket.IO baÄŸlandÄ±: " + socket.id);
      // Sunucuya katÄ±lma
      socket.emit("join", {
        name,
        meeting_id: "demo-room",
        is_moderator: name.toLowerCase() === "mod"
      });
    });

    socket.on("connect_error", (err) => {
      log("BaÄŸlantÄ± hatasÄ±: " + (err && err.message ? err.message : err));
      alert("Sunucuya baÄŸlanÄ±lamadÄ±. Konsolu kontrol edin.");
    });

    socket.on("disconnect", (reason) => {
      log("Socket.IO koptu: " + reason);
      gameDiv.style.display = "none";
      controlsDiv.style.display = "none";
      document.getElementById("login").style.display = "block";
    });

    // Uygulama event'leri
    socket.on("joined", (data) => {
      participantId = data.participant_id;
      joinSent = true;
      log("Odaya katÄ±ldÄ±n. Participant ID: " + participantId);
      document.getElementById("login").style.display = "none";
      gameDiv.style.display = "block";
    });

    socket.on("participants_update", (list) => {
      // ModeratÃ¶r kontrolÃ¼
      const me = list.find(p => p.id === participantId);
      if (me && me.is_moderator) {
        controlsDiv.style.display = "block";
      }
      // SkorlarÄ± da gÃ¼ncelle (puan 0 olsa bile tablo gÃ¶rÃ¼nsÃ¼n)
      updateScoresFromList(list);
    });

    socket.on("leaderboard", (list) => {
      // list: [{id,name,score}, ...]
      scoresList.innerHTML = "";
      list.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name}: ${p.score} puan`;
        scoresList.appendChild(li);
      });
    });

    socket.on("start_round", (data) => {
      winnerBox.style.display = "none";
      currentRoundId = data.round_id;

      questionDiv.textContent = data.question.text;
      answersDiv.innerHTML = "";
      (data.question.choices || []).forEach((ans, idx) => {
        const btn = document.createElement("button");
        btn.textContent = ans;
        btn.className = "answer-btn";
        btn.onclick = () => {
          socket.emit("answer", {
            round_id: currentRoundId,
            selected_index: idx
          });
          disableChoices();
        };
        answersDiv.appendChild(btn);
      });

      startTimer(10);
      log("Yeni soru baÅŸladÄ±.");
    });

    socket.on("player_answered", (data) => {
      // {player_id, correct, points, elapsed}
      const who = data.player_id === participantId ? "Sen" : "Bir oyuncu";
      const corr = data.correct ? "doÄŸru" : "yanlÄ±ÅŸ";
      log(`${who} cevap verdi (${corr}). Puan: ${data.points}`);
    });

    socket.on("round_result", (data) => {
      // {round_id, correct_index}
      clearInterval(timerInterval);
      disableChoices();
      // DoÄŸru ÅŸÄ±kkÄ± yeÅŸil, diÄŸerlerini pasifleÅŸtirelim (opsiyonel)
      const idx = data.correct_index;
      const btns = document.querySelectorAll(".answer-btn");
      if (btns[idx]) btns[idx].style.background = "#05c46b";
      log("SÃ¼re bitti. DoÄŸru ÅŸÄ±k: " + (typeof idx === "number" ? idx+1 : "?"));
    });

    socket.on("game_over", (data) => {
      // {winner}
      winnerBox.style.display = "block";
      winnerBox.textContent = "Kazanan: " + data.winner;
      log("Oyun bitti. Kazanan: " + data.winner);
    });
  };

  // ModeratÃ¶r: Yeni soru
  startBtn.onclick = () => {
    if (!socket) return;
    socket.emit("start_round", {});
  };

  function updateScoresFromList(list) {
    scoresList.innerHTML = "";
    list
      .slice()
      .sort((a,b) => b.score - a.score)
      .forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name}: ${p.score} puan`;
        scoresList.appendChild(li);
      });
  }
</script>

</body>
</html>
